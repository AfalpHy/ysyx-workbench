From 6a18f346bb34b1f6248c33fa550f37b1375b80be Mon Sep 17 00:00:00 2001
From: AfalpHy <736353503@qq.com>
Date: Fri, 28 Feb 2025 11:32:16 +0800
Subject: [PATCH 25/29] modify apb_delayer

---
 perip/amba/apb_delayer.v | 81 ++++++++++++++++++++++++++--------------
 1 file changed, 54 insertions(+), 27 deletions(-)

diff --git a/perip/amba/apb_delayer.v b/perip/amba/apb_delayer.v
index c0d20764..48fad4e7 100644
--- a/perip/amba/apb_delayer.v
+++ b/perip/amba/apb_delayer.v
@@ -1,38 +1,65 @@
-module apb_delayer(
-  input         clock,
-  input         reset,
-  input  [31:0] in_paddr,
-  input         in_psel,
-  input         in_penable,
-  input  [2:0]  in_pprot,
-  input         in_pwrite,
-  input  [31:0] in_pwdata,
-  input  [3:0]  in_pstrb,
-  output        in_pready,
-  output [31:0] in_prdata,
-  output        in_pslverr,
+module apb_delayer (
+    input         clock,
+    input         reset,
+    input  [31:0] in_paddr,
+    input         in_psel,
+    input         in_penable,
+    input  [ 2:0] in_pprot,
+    input         in_pwrite,
+    input  [31:0] in_pwdata,
+    input  [ 3:0] in_pstrb,
+    output        in_pready,
+    output [31:0] in_prdata,
+    output        in_pslverr,
 
-  output [31:0] out_paddr,
-  output        out_psel,
-  output        out_penable,
-  output [2:0]  out_pprot,
-  output        out_pwrite,
-  output [31:0] out_pwdata,
-  output [3:0]  out_pstrb,
-  input         out_pready,
-  input  [31:0] out_prdata,
-  input         out_pslverr
+    output [31:0] out_paddr,
+    output        out_psel,
+    output        out_penable,
+    output [ 2:0] out_pprot,
+    output        out_pwrite,
+    output [31:0] out_pwdata,
+    output [ 3:0] out_pstrb,
+    input         out_pready,
+    input  [31:0] out_prdata,
+    input         out_pslverr
 );
+  reg done;
+  reg [31:0] prdata;
+  reg pready;
 
+  integer counter;
+  always @(posedge clock) begin
+    if (reset) begin
+      done <= 0;
+      counter = 0;
+      pready <= 0;
+      prdata <= 0;
+    end else begin
+      if (pready) pready <= 0;
+      else if (in_penable & out_pready) begin
+        counter = counter + 360;  // 2.8 * 128(cpu clock 380MHZ)
+        counter = counter >> 7;
+        done   <= 1;
+        prdata <= out_prdata;
+      end else if (out_penable) counter = counter + 360;
+      else if (in_penable) begin
+        counter = counter - 1;
+        if (counter == 0) begin
+          done   <= 0;
+          pready <= 1;
+        end
+      end
+    end
+  end
   assign out_paddr   = in_paddr;
-  assign out_psel    = in_psel;
-  assign out_penable = in_penable;
+  assign out_psel    = in_psel & ~done;
+  assign out_penable = in_penable & ~done;
   assign out_pprot   = in_pprot;
   assign out_pwrite  = in_pwrite;
   assign out_pwdata  = in_pwdata;
   assign out_pstrb   = in_pstrb;
-  assign in_pready   = out_pready;
-  assign in_prdata   = out_prdata;
+  assign in_pready   = pready;
+  assign in_prdata   = prdata;
   assign in_pslverr  = out_pslverr;
 
 endmodule
-- 
2.34.1

