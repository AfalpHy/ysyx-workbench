From 9bb13af8f120503d63295d586a0802a035b21bfe Mon Sep 17 00:00:00 2001
From: AfalpHy <736353503@qq.com>
Date: Wed, 12 Feb 2025 21:32:18 +0800
Subject: [PATCH 06/29] verilator may have bug

---
 perip/psram/efabless/EF_PSRAM_CTRL.v | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/perip/psram/efabless/EF_PSRAM_CTRL.v b/perip/psram/efabless/EF_PSRAM_CTRL.v
index ce26057c..802fe878 100644
--- a/perip/psram/efabless/EF_PSRAM_CTRL.v
+++ b/perip/psram/efabless/EF_PSRAM_CTRL.v
@@ -61,7 +61,7 @@ module PSRAM_READER (
     localparam  IDLE = 1'b0,
                 READ = 1'b1;
 
-    wire [7:0]  FINAL_COUNT = qpi ? 13 + size*2 : 19 + size*2; // was 27: Always read 1 word
+    wire [7:0]  FINAL_COUNT = 21; // was 27: Always read 1 word
 
     reg         state, nstate;
     reg [7:0]   counter;
@@ -116,7 +116,7 @@ module PSRAM_READER (
     // Sample with the negedge of sck
     wire[1:0] byte_index = {counter[7:1] - (qpi ? 8'd7 : 8'd10)}[1:0];
     always @ (posedge clk)
-        if(counter >= (qpi ? 14 : 20) && counter < FINAL_COUNT)
+        if(counter >= (qpi ? 14 : 20) && counter <= FINAL_COUNT)
             if(sck)
                 data[byte_index] <= {data[byte_index][3:0], din}; // Optimize!
 
@@ -142,7 +142,6 @@ module PSRAM_READER (
     assign douten   = (counter < (qpi ? 8 : 14));
 
     assign done     = counter == FINAL_COUNT + 1;
-    // assign done     = counter == 8'h1B;
 
     generate
         genvar i;
-- 
2.34.1

