From 953915a9bdba4044c16ad09c2148ccc9a5db3e51 Mon Sep 17 00:00:00 2001
From: AfalpHy <736353503@qq.com>
Date: Wed, 19 Feb 2025 20:13:51 +0800
Subject: [PATCH 22/29] trivial

---
 perip/spi/rtl/spi_top_apb.v | 44 ++++++++++++++++++-------------------
 src/Top.scala               |  2 +-
 2 files changed, 22 insertions(+), 24 deletions(-)

diff --git a/perip/spi/rtl/spi_top_apb.v b/perip/spi/rtl/spi_top_apb.v
index 02524d49..3daef6b2 100644
--- a/perip/spi/rtl/spi_top_apb.v
+++ b/perip/spi/rtl/spi_top_apb.v
@@ -75,26 +75,27 @@ module spi_top_apb #(
       wb_we_i <= 0;
     end else begin
       if (state == NORMAL) begin
-        if (in_paddr[31:28] == 4'h3) begin
-          wb_adr_i  <= 4;
-          wb_dat_i  <= {8'h03, in_paddr[23:0]};
-          wb_sel_i  <= 4'b1111;
-          wb_we_i   <= 1;
-          in_pready <= 0;
-          if (in_penable) begin
+        if (in_pready) in_pready <= 0;
+        else begin
+          if (in_paddr[31:28] == 4'h3 && in_penable) begin
+            wb_adr_i <= 4;
+            wb_dat_i <= {8'h03, in_paddr[23:0]};
+            wb_sel_i <= 4'b1111;
+            wb_we_i <= 1;
+            in_pready <= 0;
             state <= XIP;
             xip_state <= XIP_CMD;
-          end
-        end else begin
-          if (wb_ack_o) begin
-            wb_we_i   <= 0;
-            in_pready <= 1;
           end else begin
-            wb_adr_i  <= in_paddr[4:0];
-            wb_dat_i  <= in_pwdata;
-            wb_sel_i  <= in_pstrb;
-            wb_we_i   <= in_pwrite;
-            in_pready <= 0;
+            if (wb_ack_o) begin
+              wb_we_i   <= 0;
+              in_pready <= 1;
+            end else begin
+              wb_adr_i  <= in_paddr[4:0];
+              wb_dat_i  <= in_pwdata;
+              wb_sel_i  <= in_pstrb;
+              wb_we_i   <= in_pwrite;
+              in_pready <= 0;
+            end
           end
         end
       end else begin
@@ -136,12 +137,9 @@ module spi_top_apb #(
             end
           end
         end else begin
-          if (wb_ack_o) in_pready <= 1;
-          else begin
-            // when in_penable is false, the inst have completed
-            if (~in_penable) begin
-              state <= NORMAL;
-            end
+          if (wb_ack_o) begin
+            in_pready <= 1;
+            state <= NORMAL;
           end
         end
       end
diff --git a/src/Top.scala b/src/Top.scala
index c00378a6..ecb0f09c 100644
--- a/src/Top.scala
+++ b/src/Top.scala
@@ -6,7 +6,7 @@ import freechips.rocketchip.system._
 import freechips.rocketchip.diplomacy.LazyModule
 
 object Config {
-  def hasChipLink: Boolean = false
+  def hasChipLink: Boolean = true
   def sdramUseAXI: Boolean = false
 }
 
-- 
2.34.1

