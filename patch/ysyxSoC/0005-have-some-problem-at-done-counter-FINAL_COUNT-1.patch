From 6d5fc6a827b8942a8e8618face69b61927005d58 Mon Sep 17 00:00:00 2001
From: AfalpHy <736353503@qq.com>
Date: Wed, 12 Feb 2025 20:12:26 +0800
Subject: [PATCH 05/29] have some problem at done = counter == FINAL_COUNT + 1

---
 perip/psram/efabless/EF_PSRAM_CTRL.v | 12 +++++++-----
 perip/psram/psram.v                  |  2 +-
 2 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/perip/psram/efabless/EF_PSRAM_CTRL.v b/perip/psram/efabless/EF_PSRAM_CTRL.v
index c46e6245..ce26057c 100644
--- a/perip/psram/efabless/EF_PSRAM_CTRL.v
+++ b/perip/psram/efabless/EF_PSRAM_CTRL.v
@@ -114,9 +114,9 @@ module PSRAM_READER (
             saddr <= {addr[23:0]};
 
     // Sample with the negedge of sck
-    wire[1:0] byte_index = {counter[7:1] - 8'd10}[1:0];
+    wire[1:0] byte_index = {counter[7:1] - (qpi ? 8'd7 : 8'd10)}[1:0];
     always @ (posedge clk)
-        if(counter >= (qpi ? 14 : 20) && counter <= FINAL_COUNT)
+        if(counter >= (qpi ? 14 : 20) && counter < FINAL_COUNT)
             if(sck)
                 data[byte_index] <= {data[byte_index][3:0], din}; // Optimize!
 
@@ -141,7 +141,8 @@ module PSRAM_READER (
 
     assign douten   = (counter < (qpi ? 8 : 14));
 
-    assign done     = (counter == FINAL_COUNT+1);
+    assign done     = counter == FINAL_COUNT + 1;
+    // assign done     = counter == 8'h1B;
 
     generate
         genvar i;
@@ -293,8 +294,9 @@ module PSRAM_CHANGE (
     always @*
         case (state)
             IDLE: if(enable & ~qpi) nstate = WRITE; else nstate = IDLE;
-            WRITE: if(done) begin qpi = 1;
-             nstate = IDLE;
+            WRITE: if(done) begin 
+                qpi = 1;
+                nstate = IDLE;
             end else nstate = WRITE;
         endcase
 
diff --git a/perip/psram/psram.v b/perip/psram/psram.v
index 9f25f3a7..80d3556c 100644
--- a/perip/psram/psram.v
+++ b/perip/psram/psram.v
@@ -77,7 +77,7 @@ module psram (
         else begin
           if (cnt == cmd_cnt + 6) begin
             data <= rdata;
-          end else if (cnt >= cmd_cnt + 15) begin
+          end else if (cnt >= cmd_cnt + 13) begin
             if (cnt[0]) begin
               data[7:4] <= data[3:0];
             end else data <= data >> 8;
-- 
2.34.1

