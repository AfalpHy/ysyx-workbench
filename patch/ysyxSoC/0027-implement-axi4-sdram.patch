From 642bfb912864f8cc405e7e833320e288a3985cec Mon Sep 17 00:00:00 2001
From: AfalpHy <736353503@qq.com>
Date: Fri, 28 Mar 2025 20:10:31 +0800
Subject: [PATCH 27/29] implement axi4 sdram

---
 perip/sdram/core_sdram_axi4/sdram_axi.v |  6 +++---
 perip/sdram/sdram_top_axi.v             | 16 +++++++++++-----
 src/Top.scala                           |  4 ++--
 3 files changed, 16 insertions(+), 10 deletions(-)

diff --git a/perip/sdram/core_sdram_axi4/sdram_axi.v b/perip/sdram/core_sdram_axi4/sdram_axi.v
index 64641f58..e743eb16 100644
--- a/perip/sdram/core_sdram_axi4/sdram_axi.v
+++ b/perip/sdram/core_sdram_axi4/sdram_axi.v
@@ -53,7 +53,7 @@ module sdram_axi
     ,input  [  7:0]  inport_arlen_i
     ,input  [  1:0]  inport_arburst_i
     ,input           inport_rready_i
-    ,input  [ 15:0]  sdram_data_input_i
+    ,input  [ 31:0]  sdram_data_input_i
 
     // Outputs
     ,output          inport_awready_o
@@ -73,10 +73,10 @@ module sdram_axi
     ,output          sdram_ras_o
     ,output          sdram_cas_o
     ,output          sdram_we_o
-    ,output [  1:0]  sdram_dqm_o
+    ,output [  3:0]  sdram_dqm_o
     ,output [ 12:0]  sdram_addr_o
     ,output [  1:0]  sdram_ba_o
-    ,output [ 15:0]  sdram_data_output_o
+    ,output [ 31:0]  sdram_data_output_o
     ,output          sdram_data_out_en_o
 );
 
diff --git a/perip/sdram/sdram_top_axi.v b/perip/sdram/sdram_top_axi.v
index f0fd6fdb..cf5f00db 100644
--- a/perip/sdram/sdram_top_axi.v
+++ b/perip/sdram/sdram_top_axi.v
@@ -39,18 +39,24 @@ module sdram_top_axi(
   output        sdram_we,
   output [12:0] sdram_a,
   output [ 1:0] sdram_ba,
-  output [ 1:0] sdram_dqm,
-  inout  [15:0] sdram_dq
+  output [ 3:0] sdram_dqm,
+  inout  [31:0] sdram_dq,
+  output reg    sdram_sel
 );
 
+  always @(posedge in_arvalid or posedge in_awvalid) begin
+    if(in_arvalid) sdram_sel = in_araddr[25];
+    else sdram_sel = in_awaddr[25];
+  end
+  
   wire sdram_dout_en;
-  wire [15:0] sdram_dout;
-  assign sdram_dq = sdram_dout_en ? sdram_dout : 16'bz;
+  wire [31:0] sdram_dout;
+  assign sdram_dq = sdram_dout_en ? sdram_dout : 32'bz;
   sdram_axi #(
     .SDRAM_MHZ(100),
     .SDRAM_ADDR_W(24),
     .SDRAM_COL_W(9),
-    .SDRAM_READ_LATENCY(2)
+    .SDRAM_READ_LATENCY(1)
   ) u_sdram_axi(
     .clk_i(clock),
     .rst_i(reset),
diff --git a/src/Top.scala b/src/Top.scala
index ecb0f09c..2913155b 100644
--- a/src/Top.scala
+++ b/src/Top.scala
@@ -6,8 +6,8 @@ import freechips.rocketchip.system._
 import freechips.rocketchip.diplomacy.LazyModule
 
 object Config {
-  def hasChipLink: Boolean = true
-  def sdramUseAXI: Boolean = false
+  def hasChipLink: Boolean = false
+  def sdramUseAXI: Boolean = true
 }
 
 class ysyxSoCTop extends Module {
-- 
2.34.1

