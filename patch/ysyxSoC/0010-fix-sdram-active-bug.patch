From 2cf3b75f3ea9d7a129b349d6de3ba2bcf036e9b8 Mon Sep 17 00:00:00 2001
From: AfalpHy <736353503@qq.com>
Date: Sun, 16 Feb 2025 16:23:56 +0800
Subject: [PATCH 10/29] fix sdram active bug

---
 perip/sdram/sdram.v | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/perip/sdram/sdram.v b/perip/sdram/sdram.v
index 22d70423..7818e68b 100644
--- a/perip/sdram/sdram.v
+++ b/perip/sdram/sdram.v
@@ -45,6 +45,7 @@ module sdram (
   assign dq = read ? data_buffer[15:0] : 16'hz;
 
   reg [23:0] addr;
+  reg [12:0] addr_row[0:3];
 
   always @(posedge clk) begin
     if (cke) begin
@@ -55,18 +56,19 @@ module sdram (
           else state <= IDLE;
         end
         CMD_ACTIVE: begin
-          read <= 0;
-          addr[23:11] <= a;
+          addr_row[ba] <= a;
           state <= ACTIVATE;
         end
         CMD_READ: begin
           addr[8:1] <= a[8:1];
           addr[10:9] <= ba;
+          addr[23:11] <= addr_row[ba];
           state <= READ;
         end
         CMD_WRITE: begin
           addr[8:1] <= a[8:1];
           addr[10:9] <= ba;
+          addr[23:11] <= addr_row[ba];
           data_buffer[15:0] <= dq;
           dqm_buffer <= dqm;
           state <= WRITE0;
-- 
2.34.1

